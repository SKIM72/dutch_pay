<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="appTitle">Settle Up | 간편 정산 도우미</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css?v=12">
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
</head>
<body>
    <div id="app">
        <header>
            <div class="brand-container">
                <img src="icon.png" alt="Settle Up Icon" id="app-icon">
                <h1>Settle Up</h1>
            </div>
            <div class="header-controls">
                <div class="language-selector">
                    <i class="fas fa-globe"></i>
                    <select id="language-switcher">
                        <option value="ko">한국어</option>
                        <option value="en">English</option>
                        <option value="ja">日本語</option>
                    </select>
                </div>
                <button id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
            </div>
        </header>

        <div id="main-container">
            <aside id="left-pane">
                <div class="sidebar-content">
                    <h2 data-i18n="settlementHistory">정산 내역 조회</h2>
                    <div id="settlement-list-container"></div>
                </div>
            </aside>

            <main id="right-pane">
                <div id="placeholder-right-pane">
                    <i class="fas fa-wallet"></i>
                    <p data-i18n="selectOrCreateSettlement">정산 건을 선택하거나 새로운 정산을 시작하세요.</p>
                </div>
                
                <div id="calculator" class="hidden">
                    <div class="settlement-header">
                        <div class="header-title-group">
                            <h2 id="settlement-display"></h2>
                            <button id="exchange-rate-info-btn" class="btn-outline">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                        <div class="header-action-group">
                            <button id="copy-text-btn" class="btn-outline">
                                <i class="fas fa-copy"></i> <span data-i18n="copyText">정산 결과 텍스트로 복사하기</span>
                            </button>
                            <button id="save-image-btn" class="btn-outline">
                                <i class="fas fa-camera"></i> <span data-i18n="saveImage">정산 결과 이미지로 저장하기</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card" id="summary-card">
                        <div class="summary-left">
                            <h2><i class="fas fa-chart-pie"></i><span data-i18n="settlementResult"></span></h2>
                            <div id="total-expense" data-i18n="totalExpense">총 지출: 0 JPY</div>
                        </div>
                        <div class="summary-right">
                            <div id="final-settlement-container"></div>
                            <button id="complete-settlement-btn" class="hidden"></button>
                        </div>
                    </div>

                    <div class="card" id="expense-form-card">
                        <h2><i class="fas fa-plus-circle"></i><span data-i18n="addExpense"></span></h2>
                        <div id="expense-form">
                            <div class="form-grid-row">
                                <input type="datetime-local" id="item-date" title="지출 일시">
                                <input type="text" id="item-name" data-i18n-placeholder="expenseItem">
                            </div>
                            <div class="amount-input-wrapper" style="margin-bottom: 1rem;">
                                <input type="text" id="item-amount" data-i18n-placeholder="amount" inputmode="decimal">
                                <select id="item-currency">
                                    <option value="JPY">JPY</option>
                                    <option value="KRW">KRW</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                            
                            <div id="add-rate-config-wrapper" class="rate-config-wrapper hidden">
                                <div class="rate-config-inner">
                                    <div class="rate-input-row">
                                        <span class="rate-label" data-i18n="customRateLabel">적용 환율</span>
                                        <div class="rate-input-box">
                                            <span>1 <span id="add-currency-from"></span> =</span>
                                            <input type="number" id="add-custom-rate" step="0.0001">
                                            <span id="add-currency-to"></span>
                                        </div>
                                    </div>
                                    <div class="rate-action-buttons">
                                        <button type="button" id="add-settlement-rate-btn" class="rate-btn btn-outline-small"><i class="fas fa-calendar-check"></i> <span data-i18n="applySettlementRate">정산일 기준</span></button>
                                        <button type="button" id="add-live-rate-btn" class="rate-btn btn-outline-small"><i class="fas fa-bolt"></i> <span data-i18n="applyLiveRate">실시간 최신</span></button>
                                    </div>
                                </div>
                                <div class="converted-preview">
                                    <span data-i18n="convertedAmount">최종 변환 금액</span>: <strong id="add-converted-total">0</strong>
                                </div>
                            </div>

                            <div class="form-grid-row">
                                <select id="item-payer"></select>
                                <select id="split-method" data-i18n-options="splitEqually,splitByAmount"></select>
                            </div>
                            <div id="split-amount-inputs" class="hidden dynamic-split-grid"></div>
                            
                            <button id="add-expense-btn" data-i18n="recordExpense"></button>
                        </div>
                    </div>

                    <div class="card" id="expense-list-card">
                        <div class="card-header">
                            <h2><i class="fas fa-list"></i><span data-i18n="detailedExpenseList"></span></h2>
                            <button id="download-excel-btn"><i class="fas fa-download"></i> <span data-i18n="downloadExcel">엑셀 다운로드</span></button>
                        </div>
                        <div id="expense-table-container">
                            <table id="expense-table">
                                <thead>
                                    <tr id="expense-table-header-row">
                                        <th data-i18n="tableHeaderItem">항목</th>
                                        <th data-i18n="tableHeaderTotal">총액</th>
                                        <th data-i18n="tableHeaderPayer">결제자</th>
                                        <th data-i18n="tableHeaderActions">관리</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <button id="add-settlement-fab"><i class="fas fa-plus"></i></button>

        <div id="add-settlement-modal" class="hidden">
             <div class="modal-content card">
                <span class="close-modal-btn"><i class="fas fa-times"></i></span>
                <div class="modal-header" style="justify-content: space-between;">
                    <h2 data-i18n="newSettlement">새로운 정산</h2>
                    <input type="date" id="new-settlement-date" class="modal-date-picker">
                </div>
                <input type="text" id="new-settlement-title" data-i18n-placeholder="settlementTitlePlaceholder" style="margin-bottom: 1rem;">
                
                <div class="participant-section" style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-muted); font-size: 0.9rem; font-weight: 600;">참가자 명단</label>
                    <div id="participant-list-container" style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 0.8rem;"></div>
                    <button type="button" id="add-participant-btn" class="btn-outline" style="width: 100%; justify-content: center; border-style: dashed;">
                        <i class="fas fa-plus"></i> 참가자 추가
                    </button>
                </div>

                <div class="currency-select-wrapper">
                    <label for="base-currency" data-i18n="baseCurrency">기준 통화:</label>
                    <select id="base-currency">
                        <option value="JPY">JPY (일본 엔)</option>
                        <option value="KRW">KRW (한국 원)</option>
                        <option value="USD">USD (미국 달러)</option>
                    </select>
                </div>
                <button id="create-settlement-btn" data-i18n="create"></button>
            </div>
        </div>

        <div id="exchange-rate-modal" class="hidden">
            <div class="modal-content card">
                <span class="close-modal-btn"><i class="fas fa-times"></i></span>
                <div class="modal-header">
                    <h2 data-i18n="exchangeRateTitle">환율 정보</h2>
                </div>
                <p id="exchange-rate-date"></p>
                <div id="exchange-rate-info"></div>
                <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted); text-align: center;">
                    <i class="fas fa-info-circle"></i> <span data-i18n="rateNotice">입력창에서 지출 건별로 원하는 환율을 직접 수정할 수 있습니다.</span>
                </p>
            </div>
        </div>

        <div id="expense-rate-modal" class="hidden">
            <div class="modal-content card" style="max-width: 400px;">
                <span class="close-modal-btn"><i class="fas fa-times"></i></span>
                <h2 style="margin-bottom: 1.5rem;"><i class="fas fa-calculator"></i> <span data-i18n="appliedExchangeRate">적용된 환율 상세</span></h2>
                
                <div class="rate-calc-box">
                    <div class="rate-row">
                        <span class="currency-flag" id="calc-foreign-currency"></span>
                        <span class="currency-amount" id="calc-foreign-amount">1</span>
                    </div>
                    <div class="rate-divider"><i class="fas fa-equals"></i></div>
                    <div class="rate-row base-row">
                        <span class="currency-flag" id="calc-base-currency"></span>
                        <span class="currency-amount" id="calc-base-amount"></span>
                    </div>
                </div>

                <div class="calc-result-summary">
                    <p data-i18n="totalConverted">총 변환 금액</p>
                    <div class="calc-result-numbers">
                        <span id="calc-total-foreign" class="text-muted"></span>
                        <i class="fas fa-arrow-right"></i>
                        <span id="calc-total-base" class="text-primary-bold"></span>
                    </div>
                </div>
            </div>
        </div>

        <div id="edit-expense-modal" class="hidden">
            <div class="modal-content card">
                <span class="close-modal-btn"><i class="fas fa-times"></i></span>
                <input type="hidden" id="edit-expense-id">
                <h2 data-i18n="editExpense">지출 수정</h2>
                <div class="form-grid-row" style="margin-top: 1rem;">
                    <input type="datetime-local" id="edit-item-date" title="지출 일시">
                    <input type="text" id="edit-item-name" data-i18n-placeholder="expenseItem">
                </div>
                <div class="amount-input-wrapper" style="margin-bottom: 1rem;">
                    <input type="text" id="edit-item-amount" data-i18n-placeholder="amount" inputmode="decimal">
                    <select id="edit-item-currency"></select>
                </div>

                <div id="edit-rate-config-wrapper" class="rate-config-wrapper hidden">
                    <div class="rate-config-inner">
                        <div class="rate-input-row">
                            <span class="rate-label" data-i18n="customRateLabel">적용 환율</span>
                            <div class="rate-input-box">
                                <span>1 <span id="edit-currency-from"></span> =</span>
                                <input type="number" id="edit-custom-rate" step="0.0001">
                                <span id="edit-currency-to"></span>
                            </div>
                        </div>
                        <div class="rate-action-buttons">
                            <button type="button" id="edit-settlement-rate-btn" class="rate-btn btn-outline-small"><i class="fas fa-calendar-check"></i> <span data-i18n="applySettlementRate">정산일 기준</span></button>
                            <button type="button" id="edit-live-rate-btn" class="rate-btn btn-outline-small"><i class="fas fa-bolt"></i> <span data-i18n="applyLiveRate">실시간 최신</span></button>
                        </div>
                    </div>
                    <div class="converted-preview">
                        <span data-i18n="convertedAmount">최종 변환 금액</span>: <strong id="edit-converted-total">0</strong>
                    </div>
                </div>

                <div class="form-grid-row">
                    <select id="edit-item-payer"></select>
                    <select id="edit-split-method" data-i18n-options="splitEqually,splitByAmount"></select>
                </div>
                <div id="edit-split-amount-inputs" class="hidden dynamic-split-grid"></div>
                
                <button id="save-expense-changes-btn" data-i18n="saveChanges"></button>
            </div>
        </div>

    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="locales.js"></script>
    <script src="main.js?v=12"></script>
</body>
</html>